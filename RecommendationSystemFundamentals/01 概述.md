### 课程内容设计

本次课程是由Datawhale推荐系统小组内部成员共同完成，是针对推荐系统小白的一入门课程。学习本课程需要学习者对机器学习有一定的了解，会使用常见的数据分析工具(Numpy, Pandas)，了解向量检索工具(faiss)。本次课程内容的设计参考了项亮老师的《推荐系统实践》、王喆老师的《深度学习推荐系统》以及大量的技术博客，选择了在推荐系统算法发展中比较重要的几个算法作为本次课程的核心内容，对于每个算法都进行了细致的分析以及必要的代码的演示，便于学习者们深刻理解推荐算法的本质。除此之外，每个算法都会在一个完整的数据集上从头到尾的重新把算法实现一遍，以便于学习者们可以快速的使用这些算法。在这些完整的代码中，我们给出了详细的代码注释，尽量让学习者们不会因为看不懂代码而感到烦恼。



**传统推荐系统及深度学习推荐系统的演化关系图(图来自《深度学习推荐系统》)**

<div align=center>
<img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/Javaimage-20200923143443499.png" alt="image-20200923143443499" style="zoom:38%;" />
<img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/Javaimage-20200923143559968.png" alt="image-20200923143559968" style="zoom:38%;" />
</div>

<div align=center> 传统推荐系统(左)，深度学习推荐系统(右)</div>



**核心内容：**

1. **协同过滤算法**: 包括基于用户的协同过滤(UserCF)和基于商品的协同过滤(ItemCF)，这是入门推荐系统的人必看的内容，因为这些算法可以让初学者更加容易的理解推荐算法的思想。
2. **矩阵分解算法:** 矩阵分解算法通过引入了隐向量的概念，加强了模型处理稀疏矩阵的能力，也为后续深度学习推荐系统算法中Embedding的使用打下了基础。
3. **FM(Factorization Machines):** 该算法属于对逻辑回归(LR)算法应用在推荐系统上的一个改进，在LR模型的基础上加上了特征交叉项，该思想不仅在传统的推荐算法中继续使用过，在深度学习推荐算法中也对其进行了改进与应用。
4. **GBDT+LR:** 该模型仍然是对LR模型的改进，使用树模型做特征交叉，相比于FM的二阶特征交叉，树模型可以对特征进行深度的特征交叉，充分利用了特征之间的相关性。
5. **Wide&Deep:** 从深度学习推荐系统的演化图中可以看出Wide&Deep模型处在最中间的位置，可以看出该模型在推荐系统发展中的重要地位，此外该算法模型的思想与实现都比较的简单，非常适合初学深度学习推荐系统的学习者们去学习。



### 1. 推荐系统简介

1. **What**

   - 用户：推荐系统是一种帮助用户快速发现有用信息的工具
   - 公司：推荐系统是一种增加公司产品与用户接触,购买等行为概率的工具

2. **Why**

   - 用户：在用户需求并不十分明确的情况下进行信息的过滤,与搜索系统相比,推荐系统更多的利用用户的各类历史信息猜测其可能喜欢的内容

   - 公司：解决产品能够最大限度地吸引用户,留存用户,增长用户黏性,提高用户转化率,从而达到公司商目标连续增长的目的.

   **本质上是一种实现将用户-商品-公司之间利益最大化的手段.**

3. **Who**

   从上面的1和2可以看出用户与公司是需要推荐系统的主要对象，那么可以在1和2的基础上展开想想什么样子的人需要推荐系统，以及什么样的公司需要推荐系统。

<br>

### 2. 常用评测指标

1. **用户满意度**

   用户是推荐系统中非常重要的参与者,他们的满意度也直接决定了推荐系统的好坏.但是用户满意度这个指标无法离线计算,只能通过用户调查或者在线实验获得.这里在线实验一般是通过用户的线上行为统计得到的,比如电商场景中,用户如果购买了推荐的商品说明一定程度上他们是满意的,因此可以通过购买率度量用户的满意度,与购买率类似的点击率,用户停留时间和转化率等指标都可以用来度量用户的满意度.

2. **预测准确度**

   预测准确度是用来度量用户的实际行为与推荐系统预测结果的准确度,该指标是最重要的离线评价指标,因为可以通过离线计算得到.下面是预测准确度最常用的两个指标.

   1. **评分预测**

      预测用户对物品的评分行为成为评分预测,评分预测模型通过对用户的历史物品评分记录进行建模,进而得到用户的兴趣模型,然后使用该模型预测用户未未见过商品的评分.评分预测的预测准确度一般通过均方根误差(RMSE)和平均绝对误差(MAE)计算.对于测试集中的一个用户$u$和物品$i$,令$r_{ui}$是用户$u$对物品$i$的实际评分,而$\hat{r_{ui}}$是推荐模型预测出的评分,那么RMSE可以定义为:
      $$
      RMSE = \sqrt{\frac{\sum_{u,i \in T}(r_{ui} - \hat{r}_{ui})^2}{|T|}}
      $$
      MAE定义为:
      $$
      MAE = \frac{\sum_{u,i \in T}|r_{ui} - \hat{r}_{ui}|}{|T|}
      $$
      RMSE由于存在平方项，使得使得用户真实评分与推荐系统预测评分相差较大的用户加大了惩罚，即该评测指标对系统要求更加的苛刻

   2. **TopN推荐**

      推荐系统在给用户推荐物品的时候,往往会给用户一个列表的推荐物品,这种场景下的推荐成为是TopN推荐,该推荐方式最常用的预测准确率指标一般是精确率(precision)和召回率(recall),令$R(u)$为通过推荐模型得到的推荐列表,$T(u)$为用户在实际场景中(测试集)的行为列表.

      - 精确率(precision): 分类正确的正样本个数占分类器判定为正样本的样本个数比例(这里$R(u)$相当于是模型判定的正样本)
        $$
        Precision= \frac{\sum_{u \in U}|R(u) \cap T(u)|}{\sum_{u \in U}|R(u)|}
        $$

      - 召回率(recall): 分类正确的正样本个数占真正的正样本个数的比例(这里的$T(u)$相当于真正的正样本集合)

      $$
      Recall= \frac{\sum_{u \in U}|R(u) \cap T(u)|}{\sum_{u \in U}|T(u)|}
      $$

      **有时候为了更加全面的评估TopN推荐,通常会选取不同的推荐列表长度计算多组精确率与召回率然后分别绘制出精确率曲线和召回率曲线**,需要注意的是这里并不是PR曲线,感兴趣的可以了解一下PR曲线相关的知识.

3. **覆盖率**

   **覆盖率是用来描述一个推荐系统对物品长尾的发掘能力**,一个简单的定义可以是:推荐系统所有推荐出来的商品集合数占总物品集合数的比例.但是对于相同的覆盖率,不同物品的数量分布,或者说是物品的流行度分布是可以不一样的.为了更好的描述推荐系统挖掘长尾的能力,需要统计不同物品出现次数的分布.**如果所有的物品都出现在推荐列表中,并且出现的次数都差不多,那么推荐系统发掘长尾的能力就很好.**所以可以通过研究物品在推荐列表中出现的次数分布来描述推荐系统挖掘长尾的能力,如果这个分布比较平缓说明推荐系统的覆盖率比较高,而如果分布比较陡说明推荐系统的覆盖率比较低.下面分别使用信息熵和基尼系数来定义覆盖率.

   信息熵定义覆盖率: 其中$p(i)$是物品$i$的流行度除以所有物品流行度之和
   $$
   H = -\sum_{i=1}^n p(i) logp(i)
   $$
   基尼系数定义覆盖率: 其中$i_j$是按照物品流行度p从小到大排序的物品列表中第$j$个物品
   $$
   G=\frac{1}{n-1} \sum_{j=1}^{n}(2j-n-1)p(i_{j})
   $$

4. **多样性**

   人的兴趣爱好通常是比较广泛的,所以一个好的推荐系统得到的推荐列表中应该尽可能多的包含用户的兴趣,只有这样才能增加用户找到感兴趣物品的概率.**度量推荐列表中物品的多样性换句话说就是度量推荐列表中所有物品之间的不相似性**,可以通过不同的相似性函数来度量推荐列表中商品的相似性,比如商品基于内容的相似,基于协同过滤的相似,这样就可以得到不同角度的多样性.令函数$s(i,j)$为物品$i$和物品$j$的相似性,那么用户推荐列表的多样性可以定义为:
   $$
   Diversity(R(u))=1-\frac{\sum_{i,j \in R(u)}s(i,j)}{\frac{1}{2}|R(u)|(|R(u)|-1)}
   $$
   推荐系统整体的多样性可以定义为所有用户推荐列表多样性的平均值:
   $$
   Diversity = \frac{1}{U} \sum_{u\in U}Diversity(R(u))
   $$

5. **新颖性**

   满足推荐的新颖性最简单的方法就是给用户推荐他们之前没有看过的物品,但是每个用户没见过的物品数量是非常庞大的,所以一般会计算推荐物品的平均流行度,流行度越低的物品越有可能让用户觉得新颖,因此,如果推荐结果中的物品平均热门程度比较低说明推荐的结果就可能比较新颖.

6. **AUC曲线**

   AUC（Area Under Curve），ROC曲线下与坐标轴围成的面积
   
   在讲AUC前需要理解混淆矩阵，召回率，精确率，ROC曲线等概念
   
   <img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/Java11525720-7131daae2ff90acb.png" alt="img" style="zoom:67%;" />
   
   TP：真的真了（真实值是真的，预测也是真）
   
   FN：真的假了（真实值是真的，预测为假了）
   
   FP：假的真了（真实值是假的，预测为真了）
   
   TN：假的假了（真实值是假的，预测也是假）
   
   召回率与准确率(上述已经进行了说明)，下面是另一种形势的定义，本质上都是一样的：
   $$
   Recall = \frac{TP}{TP+FN}\\
   Precise=\frac{TP}{TP+FP}
   $$
   ROC(**Receiver Operating Characteristic Curve**)曲线：
   
   <img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/Javaauc.png" alt="img" style="zoom:55%;" />
   
   ROC曲线的横坐标为假阳性率（False Positive Rate, FPR），N是真实负样本的个数， FP是N个负样本中被分类器预测为正样本的个数。
   
   纵坐标为真阳性率（True Positive Rate, TPR），P是真实正样本的个数，TP是P个正样本中被分类器预测为正样本的个数。
   
   **注：还有其他的评价指标具体可以参考项亮的《推荐系统实践》**
   
   

<br>

### 3. 召回

#### 3.1 **召回层在推荐系统架构中的位置及作用**

在推荐系统架构中召回层与排序层是推荐系统的核心算法层，而将推荐过程分成召回层与排序层主要是基于工程上的考虑，其中**召回阶段负责将海量的候选集快速缩小为几万到几千的规模；而排序层则负责对缩小后的候选集进行精准排序**。所以在召回阶段往往会利用少量的特征和简单的模型对大规模的数据集进行快速的筛选，而在排序层一般会使用更多的特征和更加复杂的模型进行精准的排序。

<br>

**下面是召回层与排序层的特点**

- **召回层：**待计算的候选集合大、计算速度快、模型简单、特征较少，尽量让用户感兴趣的物品在这个阶段能够被快速召回，即保证相关物品的召回率

- **排序层：**首要目标是得到精准的排序结果。需要处理的物品数量少，可以利用较多的特征，使用比较复杂的模型。

<br>

在设计召回层时，“计算速度”和“召回率”其实是矛盾的两个指标，为提高“计算速度”，需要使召回策略尽量简单一些；而为了提高“召回率”，要求召回策略尽量选出排序模型所需要的候选集，这也就要求召回策略不能过于简单。在权衡计算速度和召回率后，目前工业界主流的召回方法是采用多个简单策略叠加的“多路召回策略”

<br>

#### 3.2 **多路召回策略**

所谓的“多路召回”策略，就是指采用不同的策略、特征或简单模型，分别召回一部分候选集，然后把候选集混合在一起供后续排序模型使用，可以明显的看出，“多路召回策略”是在“计算速度”和“召回率”之间进行权衡的结果。其中，各种简单策略保证候选集的快速召回，从不同角度设计的策略保证召回率接近理想的状态，不至于损伤排序效果。

如下图是多路召回的一个示意图，在多路召回中，每个策略之间毫不相关，所以一般可以写并发多线程同时进行，这样可以更加高效。

<img src="https://img-blog.csdnimg.cn/20200717201411367.png#pic_center" alt="img" style="zoom: 33%;" />

上图只是一个多路召回的例子，也就是说可以使用多种不同的策略来获取用户排序的候选商品集合，**而具体使用哪些召回策略其实是与业务强相关的**，针对不同的任务就会有对于该业务真实场景下需要考虑的召回规则。例如视频推荐，召回规则可以是“热门视频”、“导演召回”、“演员召回”、“最近上映“、”流行趋势“、”类型召回“等等。

<br>

**多路召回存在的问题**

虽然多路召回权衡了计算速度和召回率的问题，可以使得用于排序的候选商品更加的丰富，但是实际的多路召回仍然存在一些问题。如上图所示，**对于每一路召回都会从商品集合中拉回K个商品，这里的K是一个超参数，对于K的选择一般需要通过离线评估加线上的A/B测试来确定合理的K值**。除此之外，对于不同的任务具体策略的选择也是人工基于经验的选择，选择的策略之间的信息是割裂的，无法总和考虑不同策略对一个物品的影响。

**基于上述问题，Embedding召回是一个综合性强且计算速度也能满足需求的召回方法。**

<br>

#### 3.3 **Embedding召回**

在当前的主流推荐系统中，Embedding的身影已经无处不在，从一定意义上可以说，把Embedding做好了，整个推荐系统的一个难题就攻克了，下面会从什么是Embedding，常见的Embedding技术有哪些，以及如何用Embedding做召回进行一个简单的总结。

<br>

**Embedding是什么？**

**Embedding其实是一种思想，主要目的是将稀疏的向量(如one-hot编码)表示转换成稠密的向量**，下图直观的显示了one-hot编码和Embedding表示的区别于联系，即Embedding相当于是对one-hot做了平滑，而onehot相当于是对Embedding做了max pooling。

<img src="https://pic3.zhimg.com/v2-1ded42011e9dd14893d7872074b808d8_r.jpg" alt="preview" style="zoom: 45%;" />

<br>

**常见的Embedding技术有哪些？**

目前主流的Embedding技术主要可以分为三大类。

- text embedding
- image embedding
- graph embedding

在推荐系统领域，text embedding技术是目前使用最多的embedding技术，对于文本特征可以直接使用该技术，**对于非文本的id类特征，可以先将其转化成id序列再使用text embedding的技术获取id的embedding再做召回**。

常见的text Embedding的技术有：

- 静态向量：word2vec, fasttext, glove
- 动态向量：ELMO, GPT, BERT

<br>

对于image embedding其实主要是对于有图或者视频的特征，目前计算机视觉模型已经发展的比较成熟了，对于图像与视频的识别都有效果比较好的模型，大部分都是卷积模块通过各种连接技巧搭建的高效模型，可以使用现有的预训练模型提取图像或者视频的向量特征，然后用于召回。

<br>

对于社交网络相关的推荐，进行推荐的用户与用于之间或者商品之间天然的存在某种复杂的图结构的关系，如何利用图中节点与节点之间的关系对其进行向量化是非常关键的，在这种场景下基于序列的text embedding和基于卷积模型的image embedding都显得力不从心，在这样的背景下Graph Embedding逐渐在推荐系统中流行起来。经典的Graph Embedding模型有, Deep Walk, Node2Vec，LINE以及比较新的阿里巴巴2018年公布的EGES graph Embedding模型。

<br>

### 4. 课后思考

**1. 为什么使用AUC**

> 例如0.7的AUC，其含义可以大概理解为：给定一个正样本和一个负样本，在70%的情况下，模型对正样本的打分高于对负样本的打分。可以看出这个解释下，我们关心的只有正负样本之间的分数高低，而具体的分支则无关紧要
>
> 【多高的AUC才算高】：
>
> 参考文章 https://zhuanlan.zhihu.com/p/24217322

<br>

**2. 如何使用Embedding做召回？**

参考腾讯的**[推荐系统 embedding 技术实践总结](https://zhuanlan.zhihu.com/p/143763320)**

<br>



### 5. 参考资料

* 王喆-《深度学习推荐系统》
* [推荐系统召回策略之多路召回与Embedding召回：https://blog.csdn.net/luanfenlian0992/article/details/107416438](https://blog.csdn.net/luanfenlian0992/article/details/107416438)
* [推荐系统 embedding 技术实践总结：https://zhuanlan.zhihu.com/p/143763320](https://zhuanlan.zhihu.com/p/143763320)

